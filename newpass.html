<!doctype html>
<html lang="my" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Reset Password</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="auth-wrapper">
      <div class="top-controls">
        <div class="lang-switcher">
          <button
            class="lang-btn active"
            id="btn-lang-toggle"
            onclick="toggleLang()"
          >
            EN
          </button>
        </div>
        <div class="nav-actions">
          <button
            class="theme-toggle nav-login-btn"
            onclick="window.location.href = 'index.html'"
            id="lbl-nav-back"
          >
            á€”á€±á€¬á€€á€ºá€á€­á€¯á€·
          </button>
          <button class="theme-toggle" onclick="toggleTheme()" id="theme-icon">
            ğŸŒ™
          </button>
        </div>
      </div>

      <div class="welcome-info">
        <div class="auth-illustration">
          <img
            src="https://raw.githubusercontent.com/your-username/your-repo/main/image1.png"
            alt="App Preview 1"
            class="hero-img"
          />
          <img
            src="https://raw.githubusercontent.com/your-username/your-repo/main/image2.png"
            alt="App Preview 2"
            class="hero-img"
          />
        </div>

        <p id="lbl-app-info">
          By using this application, you can effectively manage your income and
          expenses.
        </p>
      </div>

      <div class="auth-card">
        <div id="request-form">
          <div class="header">
            <h2 id="lbl-forgot-title">á€…á€€á€¬á€¸á€á€¾á€€á€º á€•á€¼á€”á€ºá€šá€°á€›á€”á€º</h2>
            <p class="subtitle" id="lbl-forgot-sub">
              á€™á€¾á€á€ºá€•á€¯á€¶á€á€„á€ºá€‘á€¬á€¸á€á€±á€¬ Gmail á€€á€­á€¯ á€›á€­á€¯á€€á€ºá€‘á€Šá€·á€ºá€•á€«
            </p>
          </div>
          <div class="input-group">
            <input
              type="email"
              id="reset-email"
              placeholder="Gmail á€œá€­á€•á€ºá€…á€¬"
              required
            />
          </div>
          <button
            class="primary-btn"
            id="lbl-forgot-btn"
            onclick="handleSendLink()"
          >
            Link á€•á€­á€¯á€·á€›á€”á€º
          </button>
        </div>

        <div id="update-form" class="hidden">
          <div class="header">
            <h2 id="lbl-reset-title">á€…á€€á€¬á€¸á€á€¾á€€á€ºá€¡á€á€…á€ºá€á€á€ºá€™á€¾á€á€ºá€›á€”á€º</h2>
            <p class="subtitle" id="lbl-reset-sub">
              á€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€™á€»á€¬á€¸á€€á€­á€¯ á€•á€¼á€Šá€·á€ºá€…á€¯á€¶á€…á€½á€¬á€–á€¼á€Šá€·á€ºá€•á€«
            </p>
          </div>
          <div class="input-group">
            <input
              type="email"
              id="confirm-email"
              placeholder="Gmail á€œá€­á€•á€ºá€…á€¬"
              required
            />

            <div class="password-container">
              <input
                type="password"
                id="new-password"
                placeholder="á€…á€€á€¬á€¸á€á€¾á€€á€ºá€¡á€á€…á€º"
                required
              />
              <span
                class="toggle-eye"
                onclick="togglePass('new-password', this)"
                >ğŸ‘ï¸</span
              >
            </div>

            <div class="password-container">
              <input
                type="password"
                id="confirm-password"
                placeholder="á€…á€€á€¬á€¸á€á€¾á€€á€ºá€¡á€á€Šá€ºá€•á€¼á€¯á€•á€«"
                required
              />
              <span
                class="toggle-eye"
                onclick="togglePass('confirm-password', this)"
                >ğŸ‘ï¸</span
              >
            </div>
          </div>
          <button
            class="primary-btn"
            id="lbl-reset-save-btn"
            onclick="handleUpdatePassword()"
          >
            á€á€„á€ºá€™á€Šá€º (Login)
          </button>
        </div>

        <div id="status" class="status-msg hidden"></div>

        <div class="link-container">
          <span
            class="link"
            id="lbl-go-back-link"
            onclick="window.location.href = 'index.html'"
            >á€¡á€€á€±á€¬á€„á€·á€ºá€á€„á€ºá€›á€”á€º á€…á€¬á€™á€»á€€á€ºá€”á€¾á€¬á€á€­á€¯á€· á€•á€¼á€”á€ºá€á€½á€¬á€¸á€›á€”á€º</span
          >
        </div>
      </div>
    </div>

    <script>
      const supabaseUrl = "https://utvivcjbmyhsmkjfqgra.supabase.co";
      const supabaseKey = "sb_publishable_uih5zl6drERvSSf0AN4qmQ_MqX8SY8G";
      const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

      const translations = {
        mm: {
          labels: {
            "nav-back": "á€”á€±á€¬á€€á€ºá€á€­á€¯á€·",
            "forgot-title": "á€…á€€á€¬á€¸á€á€¾á€€á€º á€•á€¼á€”á€ºá€šá€°á€›á€”á€º",
            "forgot-sub": "á€™á€¾á€á€ºá€•á€¯á€¶á€á€„á€ºá€‘á€¬á€¸á€á€±á€¬ Gmail á€€á€­á€¯ á€›á€­á€¯á€€á€ºá€‘á€Šá€·á€ºá€•á€«",
            "forgot-btn": "Link á€•á€­á€¯á€·á€›á€”á€º",
            "reset-title": "á€…á€€á€¬á€¸á€á€¾á€€á€ºá€¡á€á€…á€ºá€á€á€ºá€™á€¾á€á€ºá€›á€”á€º",
            "reset-sub": "á€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€™á€»á€¬á€¸á€€á€­á€¯ á€•á€¼á€Šá€·á€ºá€…á€¯á€¶á€…á€½á€¬á€–á€¼á€Šá€·á€ºá€•á€«",
            "reset-save-btn": "á€á€„á€ºá€™á€Šá€º (Login)",
            "go-back-link": "á€¡á€€á€±á€¬á€„á€·á€ºá€á€„á€ºá€›á€”á€º á€…á€¬á€™á€»á€€á€ºá€”á€¾á€¬á€á€­á€¯á€· á€•á€¼á€”á€ºá€á€½á€¬á€¸á€›á€”á€º",
            "app-info":
              "á€¤ Application á€€á€­á€¯ á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€á€¼á€„á€ºá€¸á€–á€¼á€„á€·á€º á€á€„á€ºá á€á€„á€ºá€„á€½á€±á€”á€¾á€„á€·á€º á€‘á€½á€€á€ºá€„á€½á€±á€™á€»á€¬á€¸á€€á€­á€¯ á€‘á€­á€›á€±á€¬á€€á€ºá€…á€½á€¬ á€…á€®á€™á€¶á€á€”á€·á€ºá€á€½á€²á€”á€­á€¯á€„á€ºá€•á€«á€á€Šá€ºá‹",
          },
          placeholders: {
            "reset-email": "Gmail á€œá€­á€•á€ºá€…á€¬",
            "confirm-email": "Gmail á€œá€­á€•á€ºá€…á€¬",
            "new-password": "á€…á€€á€¬á€¸á€á€¾á€€á€ºá€¡á€á€…á€º",
            "confirm-password": "á€…á€€á€¬á€¸á€á€¾á€€á€ºá€¡á€á€Šá€ºá€•á€¼á€¯á€•á€«",
          },
        },
        en: {
          labels: {
            "nav-back": "Back",
            "forgot-title": "Forgot Password",
            "forgot-sub": "Enter your registered Gmail",
            "forgot-btn": "Send Link",
            "reset-title": "Reset New Password",
            "reset-sub": "Fill in the details to update",
            "reset-save-btn": "Login Now",
            "go-back-link": "Back to Login Page",
            "app-info":
              "By using this application, you can effectively manage your income and expenses.",
          },
          placeholders: {
            "reset-email": "Gmail Address",
            "confirm-email": "Gmail Address",
            "new-password": "New Password",
            "confirm-password": "Confirm Password",
          },
        },
      };

      async function handleSendLink() {
        const email = document.getElementById("reset-email").value;
        if (!email) return setStatus("Email á€œá€­á€¯á€¡á€•á€ºá€•á€«á€á€Šá€º");

        const btn = document.getElementById("lbl-forgot-btn");
        btn.disabled = true;
        btn.innerText = "Sending...";

        const { error } = await _supabase.auth.resetPasswordForEmail(email, {
          redirectTo: window.location.href,
        });

        if (error) {
          setStatus(error.message);
          btn.disabled = false;
          btn.innerText = "Link á€•á€­á€¯á€·á€›á€”á€º";
        } else {
          setStatus("Gmail á€‘á€²á€á€­á€¯á€· Link á€•á€­á€¯á€·á€œá€­á€¯á€€á€ºá€•á€«á€•á€¼á€®á‹ á€…á€…á€ºá€†á€±á€¸á€€á€¼á€Šá€·á€ºá€•á€«á‹", false);
        }
      }

      async function handleUpdatePassword() {
        const email = document.getElementById("confirm-email").value;
        const newPass = document.getElementById("new-password").value;
        const confirmPass = document.getElementById("confirm-password").value;

        if (!email || !newPass || !confirmPass)
          return setStatus("á€¡á€¬á€¸á€œá€¯á€¶á€¸á€–á€¼á€Šá€·á€ºá€…á€½á€€á€ºá€•á€«");
        if (newPass !== confirmPass)
          return setStatus("á€…á€€á€¬á€¸á€á€¾á€€á€ºá€™á€»á€¬á€¸ á€á€°á€Šá€®á€™á€¾á€¯á€™á€›á€¾á€­á€•á€«");
        if (newPass.length < 6)
          return setStatus("á€…á€€á€¬á€¸á€á€¾á€€á€ºá€á€Šá€º á€¡á€”á€Šá€ºá€¸á€†á€¯á€¶á€¸ á† á€œá€¯á€¶á€¸á€›á€¾á€­á€›á€™á€Šá€º");

        const btn = document.getElementById("lbl-reset-save-btn");
        btn.disabled = true;
        btn.innerText = "Saving...";

        const { error } = await _supabase.auth.updateUser({
          password: newPass,
        });

        if (error) {
          setStatus(error.message);
          btn.disabled = false;
          btn.innerText = "á€á€„á€ºá€™á€Šá€º (Login)";
        } else {
          setStatus("á€…á€€á€¬á€¸á€á€¾á€€á€º á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€…á€½á€¬ á€•á€¼á€±á€¬á€„á€ºá€¸á€œá€²á€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹", false);
          setTimeout(() => {
            window.location.href = "dashboard.html";
          }, 1500);
        }
      }

      function togglePass(id, el) {
        const input = document.getElementById(id);
        input.type = input.type === "password" ? "text" : "password";
        el.innerText = input.type === "password" ? "ğŸ‘ï¸" : "ğŸ™ˆ";
      }

      function toggleTheme() {
        const html = document.documentElement;
        const newTheme =
          html.getAttribute("data-theme") === "light" ? "dark" : "light";
        html.setAttribute("data-theme", newTheme);
        document.getElementById("theme-icon").innerText =
          newTheme === "dark" ? "â˜€ï¸" : "ğŸŒ™";
        localStorage.setItem("theme", newTheme);
      }

      function toggleLang() {
        const currentLang = localStorage.getItem("selectedLang") || "mm";
        changeLang(currentLang === "mm" ? "en" : "mm");
      }

      function changeLang(lang) {
        localStorage.setItem("selectedLang", lang);
        const data = translations[lang];
        Object.keys(data.labels).forEach((key) => {
          const el = document.getElementById(`lbl-${key}`);
          if (el) el.innerText = data.labels[key];
        });
        Object.keys(data.placeholders).forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.placeholder = data.placeholders[id];
        });
        document.getElementById("btn-lang-toggle").innerText =
          lang === "mm" ? "á€™á€¼á€”á€ºá€™á€¬" : "EN";
      }

      function setStatus(msg, isError = true) {
        const el = document.getElementById("status");
        el.innerText = msg;
        el.className = `status-msg ${isError ? "error" : "success"}`;
        el.classList.remove("hidden");
      }

      window.onload = () => {
        const savedTheme = localStorage.getItem("theme") || "light";
        document.documentElement.setAttribute("data-theme", savedTheme);
        document.getElementById("theme-icon").innerText =
          savedTheme === "dark" ? "â˜€ï¸" : "ğŸŒ™";
        changeLang(localStorage.getItem("selectedLang") || "mm");

        if (
          window.location.hash &&
          window.location.hash.includes("type=recovery")
        ) {
          document.getElementById("request-form").classList.add("hidden");
          document.getElementById("update-form").classList.remove("hidden");
        }
      };
    </script>
  </body>
</html>
