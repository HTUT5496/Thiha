<!doctype html>
<html lang="my" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>FMS- Premium Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      const tempSupabaseUrl = "https://utvivcjbmyhsmkjfqgra.supabase.co";
      const tempSupabaseKey = "sb_publishable_uih5zl6drERvSSf0AN4qmQ_MqX8SY8G";
      const _tempSupabase = supabase.createClient(
        tempSupabaseUrl,
        tempSupabaseKey,
      );

      // Verification logic with fixed path for GitHub Pages subfolder
      _tempSupabase.auth.getSession().then(({ data: { session } }) => {
        if (!session) {
          window.location.href = "https://htut5496.github.io/Thiha/index.html";
        }
      });
    </script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="dashboard.css" />
  </head>
  <body>
    <div class="container">
      <div class="top-bar">
        <div class="user-info" id="user-profile">
          <span id="user-name">Loading...</span>
        </div>
        <div class="top-nav-actions">
          <button class="lang-btn" id="btn-lang-toggle" onclick="toggleLang()">
            ENGLISH
          </button>
          <button id="theme-icon" onclick="toggleTheme()" class="theme-toggle">
            üåô
          </button>
          <button class="logout-btn" onclick="handleLogout()">LOGOUT</button>
        </div>
      </div>

      <div class="summary-grid">
        <div
          class="summary-card inc"
          onclick="window.location.href = 'history.html?filter=income'"
          style="cursor: pointer"
        >
          <small id="lbl-income">Income</small>
          <p class="amount" id="val-income">0</p>
        </div>
        <div
          class="summary-card exp"
          onclick="window.location.href = 'history.html?filter=expense'"
          style="cursor: pointer"
        >
          <small id="lbl-expense">Expense</small>
          <p class="amount" id="val-expense">0</p>
        </div>
        <div class="summary-card bal">
          <small id="lbl-balance">Balance</small>
          <p class="amount" id="val-balance">0</p>
        </div>
      </div>

      <div class="tab-container">
        <button
          class="tab-btn active"
          id="tab-inc-head"
          onclick="switchSection('income')"
        >
          Income Sources
        </button>
        <button
          class="tab-btn"
          id="tab-exp-head"
          onclick="switchSection('expense')"
        >
          Expense Categories
        </button>
      </div>

      <div class="dashboard-main">
        <div id="income-section" class="section-content">
          <div class="category-grid" id="income-grid"></div>
          <button
            class="view-history-btn"
            onclick="window.location.href = 'history.html?filter=income'"
          >
            <i class="fa-solid fa-clock-rotate-left"></i>
            <span id="lbl-view-inc">View Income History</span>
          </button>
        </div>

        <div id="expense-section" class="section-content section-hidden">
          <div class="category-grid" id="expense-grid"></div>
          <button
            class="view-history-btn"
            onclick="window.location.href = 'history.html?filter=expense'"
          >
            <i class="fa-solid fa-clock-rotate-left"></i>
            <span id="lbl-view-exp">View Expense History</span>
          </button>
        </div>
      </div>
    </div>

    <div id="addModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header-custom">
          <h3 id="lbl-modal-title">New Transaction</h3>
          <span id="modal-cat-display"></span>
        </div>
        <div class="form-body">
          <div class="form-group"><input type="date" id="m-date" /></div>
          <div class="form-group">
            <input
              type="number"
              id="m-amount"
              placeholder="0.00"
              inputmode="decimal"
            />
          </div>
          <div class="form-group">
            <textarea id="m-notes" placeholder="Note" rows="3"></textarea>
          </div>
          <button
            class="btn-save"
            id="lbl-modal-save"
            onclick="saveFromModal()"
          >
            Save Record
          </button>
          <button
            onclick="closeModal()"
            class="btn-cancel-link"
            id="lbl-cancel"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>

    <script>
      const supabaseUrl = "https://utvivcjbmyhsmkjfqgra.supabase.co";
      const supabaseKey = "sb_publishable_uih5zl6drERvSSf0AN4qmQ_MqX8SY8G";
      const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

      let currentLang = "mm";
      let activeType = "";
      let activeCat = "";

      const catConfig = {
        Income: {
          Salary: "fa-wallet",
          Bonus: "fa-gift",
          Investment: "fa-chart-line",
          "Mote Pho": "fa-cookie",
          TransferIn: "fa-arrow-down-left",
          Gift: "fa-hand-holding-heart",
          Other: "fa-plus",
        },
        Expense: {
          Food: "fa-utensils",
          Shopping: "fa-bag-shopping",
          Bill: "fa-credit-card",
          TransferOut: "fa-arrow-up-right",
          Travel: "fa-car",
          Health: "fa-heart-pulse",
          Other: "fa-tags",
        },
      };

      const langData = {
        mm: {
          income: "·Äù·ÄÑ·Ä∫·ÄÑ·ÄΩ·Ä±",
          expense: "·Ä°·Äû·ÄØ·Ä∂·Ä∏·ÄÖ·Äõ·Ä≠·Äê·Ä∫",
          balance: "·Äú·ÄÄ·Ä∫·ÄÄ·Äª·Äî·Ä∫",
          incTitle: "·Äù·ÄÑ·Ä∫·ÄÑ·ÄΩ·Ä± ·Ä°·Äô·Äª·Ä≠·ÄØ·Ä∏·Ä°·ÄÖ·Ä¨·Ä∏·Äô·Äª·Ä¨·Ä∏",
          expTitle: "·Ä°·Äû·ÄØ·Ä∂·Ä∏·ÄÖ·Äõ·Ä≠·Äê·Ä∫ ·Ä°·Äô·Äª·Ä≠·ÄØ·Ä∏·Ä°·ÄÖ·Ä¨·Ä∏·Äô·Äª·Ä¨·Ä∏",
          viewInc: "·Äù·ÄÑ·Ä∫·ÄÑ·ÄΩ·Ä±·Äô·Äæ·Äê·Ä∫·Äê·Äô·Ä∫·Ä∏ ·ÄÄ·Äº·Ää·Ä∑·Ä∫·Äõ·Äî·Ä∫",
          viewExp: "·Ä°·Äû·ÄØ·Ä∂·Ä∏·ÄÖ·Äõ·Ä≠·Äê·Ä∫·Äô·Äæ·Äê·Ä∫·Äê·Äô·Ä∫·Ä∏ ·ÄÄ·Äº·Ää·Ä∑·Ä∫·Äõ·Äî·Ä∫",
          modalTitle: "·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏·Ä°·Äû·ÄÖ·Ä∫",
          modalSave: "·Äû·Ä≠·Äô·Ä∫·Ä∏·ÄÜ·Ää·Ä∫·Ä∏·Äô·Ää·Ä∫",
          placeAmt: "·Äï·Äô·Ä¨·Äè",
          placeNotes: "·Äô·Äæ·Äê·Ä∫·ÄÖ·ÄØ",
          cancel: "·Äô·Äú·ÄØ·Äï·Ä∫·Äê·Ä±·Ä¨·Ä∑·Äï·Ä´",
          Salary: "·Äú·ÄÖ·Ä¨",
          Bonus: "·ÄÜ·ÄØ·ÄÄ·Äº·Ä±·Ä∏",
          Investment: "·Äõ·ÄÑ·Ä∫·Ä∏·Äî·Äæ·ÄÆ·Ä∏·Äô·Äº·Äæ·ÄØ·Äï·Ä∫·Äî·Äæ·Ä∂·Äô·Äæ·ÄØ",
          "Mote Pho": "·Äô·ÄØ·Äî·Ä∑·Ä∫·Äñ·Ä≠·ÄØ·Ä∏",
          TransferIn: "·Äú·ÄΩ·Äæ·Ä≤·Äù·ÄÑ·Ä∫·ÄÑ·ÄΩ·Ä±",
          Gift: "·Äú·ÄÄ·Ä∫·ÄÜ·Ä±·Ä¨·ÄÑ·Ä∫",
          Food: "·ÄÖ·Ä¨·Ä∏·ÄÖ·Äõ·Ä≠·Äê·Ä∫",
          Shopping: "·Äù·Äö·Ä∫·Äö·Ä∞·Äô·Äæ·ÄØ",
          Bill: "·Äò·Ä±·Äú·Ä∫/·Äô·ÄÆ·Äê·Ä¨",
          TransferOut: "·Äú·ÄΩ·Äæ·Ä≤·Äë·ÄΩ·ÄÄ·Ä∫·ÄÑ·ÄΩ·Ä±",
          Travel: "·ÄÅ·Äõ·ÄÆ·Ä∏·ÄÖ·Äõ·Ä≠·Äê·Ä∫",
          Health: "·ÄÄ·Äª·Äî·Ä∫·Ä∏·Äô·Ä¨·Äõ·Ä±·Ä∏",
          Other: "·Ä°·ÄÅ·Äº·Ä¨·Ä∏",
        },
        en: {
          income: "Income",
          expense: "Expense",
          balance: "Balance",
          incTitle: "Income Sources",
          expTitle: "Expense Categories",
          viewInc: "View Income History",
          viewExp: "View Expense History",
          modalTitle: "New Transaction",
          modalSave: "Save Record",
          placeAmt: "Amount",
          placeNotes: "Notes",
          cancel: "Cancel",
          Salary: "Salary",
          Bonus: "Bonus",
          Investment: "Invest",
          "Mote Pho": "Mote Pho",
          TransferIn: "Transfer In",
          Gift: "Gift",
          Food: "Food",
          Shopping: "Shopping",
          Bill: "Bill",
          TransferOut: "Transfer Out",
          Travel: "Travel",
          Health: "Health",
          Other: "Other",
        },
      };

      function switchSection(type) {
        document
          .getElementById("income-section")
          .classList.toggle("section-hidden", type !== "income");
        document
          .getElementById("expense-section")
          .classList.toggle("section-hidden", type !== "expense");
        document
          .getElementById("tab-inc-head")
          .classList.toggle("active", type === "income");
        document
          .getElementById("tab-exp-head")
          .classList.toggle("active", type === "expense");
      }

      function renderButtons() {
        const createGrid = (type, target) => {
          const container = document.getElementById(target);
          container.innerHTML = "";
          Object.keys(catConfig[type]).forEach((cat) => {
            const btn = document.createElement("button");
            btn.className = `cat-btn ${type === "Income" ? "inc-btn" : "exp-btn"}`;
            btn.onclick = () => openModal(type, cat);
            btn.innerHTML = `
              <div class="icon-box"><i class="fa-solid ${catConfig[type][cat]}"></i></div>
              <div class="cat-info">
                <span class="cat-label">${langData[currentLang][cat] || cat}</span>
                <span class="cat-val" id="amt-${cat.replace(/\s/g, "")}">0</span>
              </div>`;
            container.appendChild(btn);
          });
        };
        createGrid("Income", "income-grid");
        createGrid("Expense", "expense-grid");
      }

      function openModal(type, cat) {
        activeType = type;
        activeCat = cat;
        document.getElementById("modal-cat-display").innerText =
          langData[currentLang][cat] || cat;
        document.getElementById("m-date").valueAsDate = new Date();
        document.getElementById("m-amount").value = "";
        document.getElementById("m-notes").value = "";
        const saveBtn = document.getElementById("lbl-modal-save");
        saveBtn.style.background = type === "Income" ? "#10b981" : "#ef4444";
        document.getElementById("addModal").classList.add("active");
        setTimeout(() => document.getElementById("m-amount").focus(), 300);
      }

      function closeModal() {
        document.getElementById("addModal").classList.remove("active");
      }

      async function saveFromModal() {
        const {
          data: { user },
        } = await _supabase.auth.getUser();
        const amt = parseFloat(document.getElementById("m-amount").value);
        if (!amt) return;
        const btn = document.getElementById("lbl-modal-save");
        btn.disabled = true;
        const { error } = await _supabase.from("transactions").insert([
          {
            date: document.getElementById("m-date").value,
            type: activeType,
            amount: amt,
            category: activeCat,
            notes: document.getElementById("m-notes").value,
            user_id: user.id,
          },
        ]);
        if (!error) {
          await loadData();
          closeModal();
        }
        btn.disabled = false;
      }

      async function loadData() {
        const {
          data: { user },
        } = await _supabase.auth.getUser();
        if (!user) return;

        // Display User Details from Google Profile
        if (user.user_metadata) {
          const name = user.user_metadata.full_name || user.email;
          const avatar = user.user_metadata.avatar_url;
          document.getElementById("user-profile").innerHTML = `
                ${avatar ? `<img src="${avatar}" class="profile-img" alt="avatar">` : ""}
                <span id="user-name">${name}</span>
            `;
        }

        const { data } = await _supabase
          .from("transactions")
          .select("*")
          .eq("user_id", user.id);
        if (data) {
          let tInc = 0,
            tExp = 0,
            sums = {};
          data.forEach((i) => {
            if (i.type === "Income") tInc += i.amount;
            else tExp += i.amount;
            const key = i.category.replace(/\s/g, "");
            sums[key] = (sums[key] || 0) + i.amount;
          });
          document.getElementById("val-income").innerText =
            tInc.toLocaleString();
          document.getElementById("val-expense").innerText =
            tExp.toLocaleString();
          document.getElementById("val-balance").innerText = (
            tInc - tExp
          ).toLocaleString();

          document
            .querySelectorAll(".cat-val")
            .forEach((el) => (el.innerText = "0"));
          Object.keys(sums).forEach((c) => {
            const el = document.getElementById(`amt-${c}`);
            if (el) el.innerText = sums[c].toLocaleString();
          });
        }
      }

      function toggleLang() {
        changeLang(currentLang === "mm" ? "en" : "mm");
      }

      function changeLang(lang) {
        currentLang = lang;
        localStorage.setItem("selectedLang", lang);
        document.getElementById("lbl-income").innerText = langData[lang].income;
        document.getElementById("lbl-expense").innerText =
          langData[lang].expense;
        document.getElementById("lbl-balance").innerText =
          langData[lang].balance;
        document.getElementById("tab-inc-head").innerText =
          langData[lang].incTitle;
        document.getElementById("tab-exp-head").innerText =
          langData[lang].expTitle;
        document.getElementById("lbl-view-inc").innerText =
          langData[lang].viewInc;
        document.getElementById("lbl-view-exp").innerText =
          langData[lang].viewExp;
        document.getElementById("btn-lang-toggle").innerText =
          lang === "mm" ? "ENGLISH" : "·Äô·Äº·Äî·Ä∫·Äô·Ä¨";
        renderButtons();
        loadData();
      }

      function toggleTheme() {
        const html = document.documentElement;
        const newTheme =
          html.getAttribute("data-theme") === "light" ? "dark" : "light";
        html.setAttribute("data-theme", newTheme);
        document.getElementById("theme-icon").innerText =
          newTheme === "dark" ? "‚òÄÔ∏è" : "üåô";
        localStorage.setItem("theme", newTheme);
      }

      async function handleLogout() {
        await _supabase.auth.signOut();
        window.location.href = "https://htut5496.github.io/Thiha/index.html";
      }

      window.onload = async () => {
        const savedTheme = localStorage.getItem("theme") || "light";
        document.documentElement.setAttribute("data-theme", savedTheme);
        document.getElementById("theme-icon").innerText =
          savedTheme === "dark" ? "‚òÄÔ∏è" : "üåô";
        changeLang(localStorage.getItem("selectedLang") || "mm");
      };
    </script>
  </body>
</html>
