<!doctype html>
<html lang="my">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Finance Tracker - Dashboard</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="dashboard.css" />
    <style>
      /* --- UI ·Äï·Äº·ÄÑ·Ä∫·ÄÜ·ÄÑ·Ä∫·Äô·Äæ·ÄØ·Äô·Äª·Ä¨·Ä∏ --- */
      .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
      }

      .lang-switcher {
        display: flex;
        background: rgba(0, 0, 0, 0.05);
        padding: 4px;
        border-radius: 12px;
        gap: 2px;
      }

      .lang-btn,
      #theme-toggle {
        border: none;
        background: transparent;
        padding: 6px 14px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        color: var(--text-color, #555);
      }

      .lang-btn.active {
        background: #ffffff;
        color: #3b82f6;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      #theme-toggle {
        background: rgba(0, 0, 0, 0.05);
        width: 40px;
        height: 40px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* --- History Link Style (Positioned above Add Card) --- */
      .history-link-container {
        margin-bottom: 15px;
      }

      .history-card-link {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        background: var(--card-bg, #ffffff);
        padding: 12px;
        border-radius: 12px;
        text-decoration: none;
        color: var(--primary, #3b82f6);
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        transition: all 0.2s ease;
        border: 1px solid rgba(0, 0, 0, 0.03);
      }

      .history-card-link:hover {
        background: var(--primary, #3b82f6);
        color: white;
        transform: translateY(-2px);
      }

      /* --- ·Äô·Ä∞·Äú Styles --- */
      .summary-card.inc,
      .summary-card.exp {
        cursor: pointer;
        transition:
          transform 0.2s,
          box-shadow 0.2s;
      }
      .summary-card.inc:hover,
      .summary-card.exp:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="top-bar">
        <div class="lang-switcher">
          <button class="lang-btn" id="btn-en" onclick="changeLang('en')">
            EN
          </button>
          <button class="lang-btn" id="btn-mm" onclick="changeLang('mm')">
            ·Äô·Äº·Äî·Ä∫·Äô·Ä¨
          </button>
        </div>

        <button id="theme-toggle" onclick="toggleTheme()">üåô</button>

        <button
          class="logout-btn"
          id="lbl-logout"
          onclick="handleLogout()"
          style="
            background: #fee2e2;
            color: #ef4444;
            border: none;
            padding: 8px 16px;
            border-radius: 10px;
            font-weight: 600;
          "
        >
          Logout
        </button>
      </div>

      <div class="summary-grid">
        <div
          class="summary-card inc"
          onclick="window.location.href = 'history.html?filter=income'"
        >
          <i class="fa-solid fa-circle-arrow-up"></i>
          <small id="lbl-income">·Äù·ÄÑ·Ä∫·ÄÑ·ÄΩ·Ä±</small>
          <p class="amount">+ <span id="val-income">0</span></p>
        </div>

        <div
          class="summary-card exp"
          onclick="window.location.href = 'history.html?filter=expense'"
        >
          <i class="fa-solid fa-circle-arrow-down"></i>
          <small id="lbl-expense">·Ä°·Äû·ÄØ·Ä∂·Ä∏·ÄÖ·Äõ·Ä≠·Äê·Ä∫</small>
          <p class="amount">- <span id="val-expense">0</span></p>
        </div>

        <div class="summary-card bal">
          <i class="fa-solid fa-wallet"></i>
          <small id="lbl-balance">·Äú·ÄÄ·Ä∫·ÄÄ·Äª·Äî·Ä∫</small>
          <p class="amount"><span id="val-balance">0</span></p>
        </div>
      </div>

      <div class="main-layout">
        <div class="left-col">
          <div class="history-link-container">
            <a
              href="history.html"
              class="history-card-link"
              id="lbl-nav-history"
            >
              <i class="fa-solid fa-clock-rotate-left"></i>
              <span>·Äô·Äæ·Äê·Ä∫·Äê·Äô·Ä∫·Ä∏·ÄÖ·Ä¨·Äô·Äª·ÄÄ·Ä∫·Äî·Äæ·Ä¨</span>
            </a>
          </div>

          <div class="card add-card">
            <h3 id="lbl-add">·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏·Ä°·Äû·ÄÖ·Ä∫·Äë·Ää·Ä∑·Ä∫·Äõ·Äî·Ä∫</h3>
            <div class="input-grid">
              <input type="date" id="date" />
              <select id="type">
                <option value="Expense" id="opt-exp">
                  ·Ä°·Äû·ÄØ·Ä∂·Ä∏·ÄÖ·Äõ·Ä≠·Äê·Ä∫ (Expense)
                </option>
                <option value="Income" id="opt-inc">·Äù·ÄÑ·Ä∫·ÄÑ·ÄΩ·Ä± (Income)</option>
              </select>
            </div>
            <input
              type="number"
              id="amount"
              placeholder="·Äï·Äô·Ä¨·Äè"
              inputmode="decimal"
              step="any"
            />
            <input list="category-list" id="category" placeholder="·ÄÅ·Ä±·Ä´·ÄÑ·Ä∫·Ä∏·ÄÖ·Äâ·Ä∫" />
            <datalist id="category-list"></datalist>
            <textarea id="notes" placeholder="·Äô·Äæ·Äê·Ä∫·ÄÖ·ÄØ" rows="2"></textarea>
            <button class="main-btn" onclick="saveTransaction()" id="lbl-save">
              ·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏·Äû·ÄΩ·ÄÑ·Ä∫·Ä∏·Äô·Ää·Ä∫
            </button>
          </div>
        </div>

        <div class="right-col">
          <div class="card chart-card">
            <h3 id="lbl-analysis">·ÄÅ·ÄΩ·Ä≤·ÄÅ·Äº·Äô·Ä∫·Ä∏·ÄÖ·Ä≠·Äê·Ä∫·Äñ·Äº·Ä¨·Äô·Äæ·ÄØ</h3>
            <div class="chart-container">
              <canvas id="expenseChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const supabaseUrl = "https://utvivcjbmyhsmkjfqgra.supabase.co";
      const supabaseKey = "sb_publishable_uih5zl6drERvSSf0AN4qmQ_MqX8SY8G";
      const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

      let currentLang = "mm";
      let myPieChart = null;

      const langData = {
        mm: {
          income: "·Äù·ÄÑ·Ä∫·ÄÑ·ÄΩ·Ä±",
          expense: "·Ä°·Äû·ÄØ·Ä∂·Ä∏·ÄÖ·Äõ·Ä≠·Äê·Ä∫",
          balance: "·Äú·ÄÄ·Ä∫·ÄÄ·Äª·Äî·Ä∫",
          add: "·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏·Äû·ÄÖ·Ä∫",
          save: "·Äû·Ä≠·Äô·Ä∫·Ä∏·Äô·Ää·Ä∫",
          "nav-history": "·Äô·Äæ·Äê·Ä∫·Äê·Äô·Ä∫·Ä∏·ÄÖ·Ä¨·Äô·Äª·ÄÄ·Ä∫·Äî·Äæ·Ä¨ ·ÄÄ·Äº·Ää·Ä∑·Ä∫·Äõ·Äî·Ä∫",
          analysis: "·Äû·ÄØ·Ä∂·Ä∏·Äû·Äï·Ä∫·ÄÅ·Äª·ÄÄ·Ä∫",
          logout: "·Äë·ÄΩ·ÄÄ·Ä∫·Äõ·Äî·Ä∫",
          "place-amt": "·Äï·Äô·Ä¨·Äè",
          "place-cat": "·ÄÅ·Ä±·Ä´·ÄÑ·Ä∫·Ä∏·ÄÖ·Äâ·Ä∫",
          "place-note": "·Äô·Äæ·Äê·Ä∫·ÄÖ·ÄØ",
          "opt-inc": "·Äù·ÄÑ·Ä∫·ÄÑ·ÄΩ·Ä±",
          "opt-exp": "·Ä°·Äû·ÄØ·Ä∂·Ä∏·ÄÖ·Äõ·Ä≠·Äê·Ä∫",
        },
        en: {
          income: "Income",
          expense: "Expense",
          balance: "Balance",
          add: "Add New",
          save: "Save",
          "nav-history": "View History Page",
          analysis: "Analysis",
          logout: "Logout",
          "place-amt": "Amount",
          "place-cat": "Category",
          "place-note": "Notes",
          "opt-inc": "Income",
          "opt-exp": "Expense",
        },
      };

      function toggleTheme() {
        const doc = document.documentElement;
        const current = doc.getAttribute("data-theme");
        const target = current === "dark" ? "light" : "dark";
        doc.setAttribute("data-theme", target);
        localStorage.setItem("theme", target);
        document.getElementById("theme-toggle").innerText =
          target === "dark" ? "‚òÄÔ∏è" : "üåô";
        loadData();
      }

      function changeLang(lang) {
        currentLang = lang;
        localStorage.setItem("selectedLang", lang);

        Object.keys(langData[lang]).forEach((key) => {
          const el = document.getElementById(`lbl-${key}`);
          if (el) {
            if (key === "nav-history") {
              el.querySelector("span").innerText = langData[lang][key];
            } else {
              el.innerText = langData[lang][key];
            }
          }
        });

        document.getElementById("amount").placeholder =
          langData[lang]["place-amt"];
        document.getElementById("category").placeholder =
          langData[lang]["place-cat"];
        document.getElementById("notes").placeholder =
          langData[lang]["place-note"];
        document.getElementById("opt-inc").innerText =
          langData[lang]["opt-inc"];
        document.getElementById("opt-exp").innerText =
          langData[lang]["opt-exp"];

        document
          .querySelectorAll(".lang-btn")
          .forEach((b) => b.classList.remove("active"));
        document.getElementById(`btn-${lang}`).classList.add("active");
        loadData();
      }

      function renderChart(income, expense) {
        const ctx = document.getElementById("expenseChart").getContext("2d");
        const isDark =
          document.documentElement.getAttribute("data-theme") === "dark";
        if (myPieChart) myPieChart.destroy();
        myPieChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels:
              currentLang === "mm"
                ? ["·Äù·ÄÑ·Ä∫·ÄÑ·ÄΩ·Ä±", "·Ä°·Äû·ÄØ·Ä∂·Ä∏·ÄÖ·Äõ·Ä≠·Äê·Ä∫"]
                : ["Income", "Expense"],
            datasets: [
              {
                data: [income, expense],
                backgroundColor: ["#00c853", "#ff3d00"],
                borderWidth: 0,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
                labels: { color: isDark ? "#ffffff" : "#5f6368" },
              },
            },
          },
        });
      }

      async function loadData() {
        const {
          data: { user },
        } = await _supabase.auth.getUser();
        if (!user) {
          window.location.href = "index.html";
          return;
        }
        const { data } = await _supabase.from("transactions").select("*");
        if (data) {
          let totalInc = 0,
            totalExp = 0;
          data.forEach((item) => {
            if (item.type === "Income") totalInc += item.amount;
            else totalExp += item.amount;
          });
          document.getElementById("val-income").innerText =
            totalInc.toLocaleString();
          document.getElementById("val-expense").innerText =
            totalExp.toLocaleString();
          document.getElementById("val-balance").innerText = (
            totalInc - totalExp
          ).toLocaleString();
          renderChart(totalInc, totalExp);
        }
      }

      async function saveTransaction() {
        const {
          data: { user },
        } = await _supabase.auth.getUser();
        const btn = document.getElementById("lbl-save");
        const payload = {
          date: document.getElementById("date").value,
          type: document.getElementById("type").value,
          amount: parseFloat(document.getElementById("amount").value),
          category: document.getElementById("category").value,
          notes: document.getElementById("notes").value,
          user_id: user.id,
        };
        if (!payload.date || !payload.amount)
          return alert("Fill required fields!");
        btn.disabled = true;
        const { error } = await _supabase
          .from("transactions")
          .insert([payload]);
        if (!error) {
          loadData();
          document.getElementById("amount").value = "";
          document.getElementById("category").value = "";
          document.getElementById("notes").value = "";
          btn.innerText = "Saved! ‚úì";
          setTimeout(() => {
            btn.innerText = langData[currentLang].save;
            btn.disabled = false;
          }, 2000);
        } else {
          btn.disabled = false;
          alert("Error saving data.");
        }
      }

      async function handleLogout() {
        await _supabase.auth.signOut();
        window.location.href = "index.html";
      }

      document
        .getElementById("type")
        .addEventListener("change", updateCategoryOptions);

      function updateCategoryOptions() {
        const type = document.getElementById("type").value;
        const dataList = document.getElementById("category-list");
        dataList.innerHTML = "";
        const options =
          type === "Income"
            ? ["Salary", "Bonus", "Gifts", "Investment", "Other"]
            : [
                "Food",
                "Transport",
                "Shopping",
                "Rent",
                "Health",
                "Bills",
                "General",
              ];
        options.forEach((opt) => {
          const el = document.createElement("option");
          el.value = opt;
          dataList.appendChild(el);
        });
      }

      // Updated window.onload to verify session persistence
      window.onload = async () => {
        // 1. Check if a session exists
        const {
          data: { session },
        } = await _supabase.auth.getSession();

        // 2. If no session, redirect to login page
        if (!session) {
          window.location.href = "index.html";
          return;
        }

        // 3. If session exists, setup existing logic
        const savedTheme = localStorage.getItem("theme") || "light";
        document.documentElement.setAttribute("data-theme", savedTheme);
        document.getElementById("theme-toggle").innerText =
          savedTheme === "dark" ? "‚òÄÔ∏è" : "üåô";
        const savedLang = localStorage.getItem("selectedLang") || "mm";
        changeLang(savedLang);
        document.getElementById("date").valueAsDate = new Date();
        updateCategoryOptions();
        loadData(); // This now runs safely knowing session exists
      };
    </script>
  </body>
</html>
