<!doctype html>
<html lang="my">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Finance Tracker - Full History</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="history.css" />
  </head>
  <body>
    <div class="history-container">
      <div class="top-header">
        <button
          class="btn-dashboard"
          onclick="window.location.href = 'dashboard.html'"
          style="
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--card-bg);
            border: 1px solid var(--border-glass);
            padding: 8px 15px;
            border-radius: 12px;
            cursor: pointer;
            color: inherit;
            font-family: inherit;
            font-weight: 600;
          "
        >
          <i
            class="fa-solid fa-house"
            style="color: var(--primary); font-size: 14px"
          ></i>
          <span id="lbl-back">Back</span>
        </button>

        <div class="header-right">
          <button
            class="theme-toggle"
            onclick="toggleDarkMode()"
            style="
              background: none;
              border: none;
              cursor: pointer;
              font-size: 18px;
              color: inherit;
            "
          >
            <i class="fa-solid fa-moon" id="theme-icon"></i>
          </button>
          <div class="lang-switcher">
            <button class="lang-btn" id="btn-en" onclick="changeLang('en')">
              EN
            </button>
            <button class="lang-btn" id="btn-mm" onclick="changeLang('mm')">
              MM
            </button>
          </div>
        </div>
      </div>

      <div class="balance-card">
        <small
          id="lbl-total-amount"
          style="
            color: #94a3b8;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 11px;
          "
          >Total Amount</small
        >
        <div class="amount" id="stat-bal">0</div>
      </div>

      <div
        class="overview-grid"
        style="
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 12px;
          margin-bottom: 20px;
        "
      >
        <button
          class="stat-btn"
          id="card-inc"
          onclick="toggleFilter('income')"
          style="
            background: var(--card-bg);
            border: 1px solid var(--border-glass);
            border-radius: 20px;
            padding: 15px;
            cursor: pointer;
            color: inherit;
          "
        >
          <h4 id="lbl-inc" style="font-size: 11px; color: #94a3b8; margin: 0">
            Income
          </h4>
          <div
            class="amount"
            id="stat-inc"
            style="color: #10b981; font-weight: 800; font-size: 18px"
          >
            0
          </div>
        </button>
        <button
          class="stat-btn"
          id="card-exp"
          onclick="toggleFilter('expense')"
          style="
            background: var(--card-bg);
            border: 1px solid var(--border-glass);
            border-radius: 20px;
            padding: 15px;
            cursor: pointer;
            color: inherit;
          "
        >
          <h4 id="lbl-exp" style="font-size: 11px; color: #94a3b8; margin: 0">
            Expense
          </h4>
          <div
            class="amount"
            id="stat-exp"
            style="color: #ef4444; font-weight: 800; font-size: 18px"
          >
            0
          </div>
        </button>
      </div>

      <div class="filter-bar">
        <div class="search-box">
          <i class="fa-solid fa-magnifying-glass"></i>
          <input
            type="text"
            id="search-bar"
            onkeyup="handleSearch(this)"
            placeholder="Search..."
          />
          <button
            id="clear-search"
            class="btn-clear-search"
            onclick="clearSearch()"
            style="display: none"
          >
            <i class="fa-solid fa-circle-xmark"></i>
          </button>
        </div>
        <div style="display: flex; gap: 8px; margin-top: 10px">
          <input
            type="date"
            id="date-from"
            onchange="loadFullHistory()"
            style="
              flex: 1;
              padding: 10px;
              border-radius: 12px;
              border: 1px solid var(--border-glass);
              background: var(--card-bg);
              color: inherit;
            "
          />
          <input
            type="date"
            id="date-to"
            onchange="loadFullHistory()"
            style="
              flex: 1;
              padding: 10px;
              border-radius: 12px;
              border: 1px solid var(--border-glass);
              background: var(--card-bg);
              color: inherit;
            "
          />
          <button
            onclick="resetFilters()"
            style="
              padding: 10px;
              border-radius: 12px;
              border: 1px solid var(--border-glass);
              background: var(--card-bg);
              cursor: pointer;
              color: inherit;
            "
          >
            <i class="fa-solid fa-rotate-right"></i>
          </button>
        </div>
      </div>

      <div
        class="history-header-row"
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin: 25px 0 15px;
        "
      >
        <span
          class="history-title"
          id="lbl-trans-title"
          style="
            font-size: 12px;
            font-weight: 800;
            color: #94a3b8;
            text-transform: uppercase;
          "
          >Transactions</span
        >
        <button
          class="btn-download-modern"
          onclick="exportCSV()"
          style="
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
          "
        >
          <i class="fa-solid fa-file-excel"></i>
          <span id="lbl-export">Export</span>
        </button>
      </div>

      <div id="full-history-list"></div>
    </div>

    <script>
      const supabaseUrl = "https://utvivcjbmyhsmkjfqgra.supabase.co";
      const supabaseKey = "sb_publishable_uih5zl6drERvSSf0AN4qmQ_MqX8SY8G";
      const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

      let allData = [];
      let currentLang = localStorage.getItem("selectedLang") || "mm";
      let activeTypeFilter = null;

      const catIcons = {
        Salary: "fa-wallet",
        Bonus: "fa-gift",
        Gifts: "fa-hand-holding-heart",
        Investment: "fa-chart-line",
        Other: "fa-plus",
        Food: "fa-utensils",
        Transport: "fa-car",
        Shopping: "fa-bag-shopping",
        Rent: "fa-house",
        Health: "fa-heart-pulse",
        Bills: "fa-credit-card",
        General: "fa-tags",
      };

      const langData = {
        mm: {
          back: "ပင်မစာမျက်နှာ",
          inc: "ဝင်ငွေ",
          exp: "အသုံးစရိတ်",
          bal: "စုစုပေါင်း ပမာဏ",
          empty: "မှတ်တမ်းမရှိပါ။",
          confirm: "ဖျက်မှာ သေချာပါသလား?",
          trans: "စာရင်းမှတ်တမ်းများ",
          export: "Excel ထုတ်ရန်",
          editNotePrompt: "မှတ်စုကို ပြင်ဆင်ရန်:",
          searchPlaceholder: "မှတ်စု ဖြင့် ရှာပါ",
          Salary: "လစာ",
          Bonus: "ဆုကြေး",
          Gifts: "လက်ဆောင်",
          Investment: "ရင်းနှီးမြှုပ်နှံမှု",
          Other: "အခြား",
          Food: "စားစရိတ်",
          Transport: "ခရီးစရိတ်",
          Shopping: "ဝယ်ယူမှု",
          Rent: "အိမ်လခ",
          Health: "ကျန်းမာရေး",
          Bills: "မီတာ/ဘေလ်",
          General: "အထွေထွေ",
        },
        en: {
          back: "Dashboard",
          inc: "Income",
          exp: "Expense",
          bal: "Total Amount",
          empty: "No records found.",
          confirm: "Delete this record?",
          trans: "Transactions",
          export: "Export CSV",
          editNotePrompt: "Edit Note:",
          searchPlaceholder: "Search by notes...",
          Salary: "Salary",
          Bonus: "Bonus",
          Gifts: "Gifts",
          Investment: "Invest",
          Other: "Other",
          Food: "Food",
          Transport: "Transport",
          Shopping: "Shopping",
          Rent: "Rent",
          Health: "Health",
          Bills: "Bills",
          General: "General",
        },
      };

      function handleSearch(input) {
        document.getElementById("clear-search").style.display = input.value
          ? "block"
          : "none";
        filterData();
      }

      function clearSearch() {
        document.getElementById("search-bar").value = "";
        document.getElementById("clear-search").style.display = "none";
        filterData();
      }

      function toggleDarkMode() {
        const target =
          document.documentElement.getAttribute("data-theme") === "dark"
            ? "light"
            : "dark";
        document.documentElement.setAttribute("data-theme", target);
        localStorage.setItem("theme", target);
        document.getElementById("theme-icon").className =
          target === "dark" ? "fa-solid fa-sun" : "fa-solid fa-moon";
      }

      function changeLang(lang) {
        currentLang = lang;
        localStorage.setItem("selectedLang", lang);

        document.getElementById("lbl-back").innerText = langData[lang].back;
        document.getElementById("lbl-inc").innerText = langData[lang].inc;
        document.getElementById("lbl-exp").innerText = langData[lang].exp;
        document.getElementById("lbl-total-amount").innerText =
          langData[lang].bal;
        document.getElementById("lbl-trans-title").innerText =
          langData[lang].trans;
        document.getElementById("lbl-export").innerText = langData[lang].export;
        document.getElementById("search-bar").placeholder =
          langData[lang].searchPlaceholder;

        document
          .querySelectorAll(".lang-btn")
          .forEach((b) => b.classList.toggle("active", b.id === `btn-${lang}`));
        renderList(allData);
      }

      function toggleFilter(type) {
        activeTypeFilter = activeTypeFilter === type ? null : type;
        loadFullHistory();
      }

      function resetFilters() {
        document.getElementById("date-from").value = "";
        document.getElementById("date-to").value = "";
        document.getElementById("search-bar").value = "";
        activeTypeFilter = null;
        loadFullHistory();
      }

      async function loadFullHistory() {
        const {
          data: { user },
        } = await _supabase.auth.getUser();
        if (!user) return (window.location.href = "index.html");

        let query = _supabase
          .from("transactions")
          .select("*")
          .order("date", { ascending: false });
        const df = document.getElementById("date-from").value;
        const dt = document.getElementById("date-to").value;

        if (df) query = query.gte("date", df);
        if (dt) query = query.lte("date", dt);
        if (activeTypeFilter === "income") query = query.eq("type", "Income");
        if (activeTypeFilter === "expense") query = query.eq("type", "Expense");

        const { data } = await query;
        if (data) {
          allData = data;
          renderList(data);
          updateFilterUI();
        }
      }

      function updateFilterUI() {
        document.getElementById("card-inc").style.borderColor =
          activeTypeFilter === "income" ? "#10b981" : "rgba(0,0,0,0.05)";
        document.getElementById("card-exp").style.borderColor =
          activeTypeFilter === "expense" ? "#ef4444" : "rgba(0,0,0,0.05)";
      }

      async function editNote(id, currentNote) {
        const newNote = prompt(
          langData[currentLang].editNotePrompt,
          currentNote || "",
        );
        if (newNote !== null) {
          const { error } = await _supabase
            .from("transactions")
            .update({ notes: newNote })
            .eq("id", id);
          if (!error) loadFullHistory();
        }
      }

      function renderList(data) {
        const listDiv = document.getElementById("full-history-list");
        listDiv.innerHTML = "";

        let tInc = 0,
          tExp = 0,
          lastMonth = "";

        data.forEach((item) => {
          if (item.type === "Income") tInc += item.amount;
          else tExp += item.amount;

          const monthName = new Date(item.date).toLocaleString(
            currentLang === "mm" ? "my-MM" : "en-US",
            { month: "long", year: "numeric" },
          );
          if (monthName !== lastMonth) {
            listDiv.innerHTML += `<div class="month-group-label">${monthName}</div>`;
            lastMonth = monthName;
          }

          const isInc = item.type === "Income";
          const icon = catIcons[item.category] || "fa-receipt";

          listDiv.innerHTML += `
            <div class="transaction-item">
              <div class="icon-circle ${isInc ? "inc-icon" : "exp-icon"}">
                <i class="fa-solid ${icon}"></i>
              </div>
              <div class="item-middle">
                <span style="font-weight:700; font-size:15px; display:block;">${langData[currentLang][item.category] || item.category}</span>
                <div class="note-bubble" onclick="editNote(${item.id}, '${item.notes || ""}')" title="Click to edit">
                  <i class="fa-solid fa-pen-to-square" style="font-size:10px; opacity:0.5; margin-right:5px;"></i>
                  ${item.notes || "..."}
                </div>
                <span style="font-size:11px; color:#94a3b8; font-weight:500;">${item.date}</span>
              </div>
              <div style="text-align: right; display: flex; flex-direction: column; justify-content: space-between;">
                <div style="font-weight: 800; font-size: 16px; color: ${isInc ? "#10b981" : "#ef4444"}">
                  ${isInc ? "+" : "-"} ${item.amount.toLocaleString()}
                </div>
                <button class="btn-del" onclick="deleteItem(${item.id})" style="background:none; border:none; cursor:pointer; color:#ef4444; opacity:0.6;">
                  <i class="fa-solid fa-trash-can"></i>
                </button>
              </div>
            </div>`;
        });

        const netBal = tInc - tExp;
        document.getElementById("stat-inc").innerText = tInc.toLocaleString();
        document.getElementById("stat-exp").innerText = tExp.toLocaleString();

        const balEl = document.getElementById("stat-bal");
        balEl.innerText = netBal.toLocaleString();
        balEl.style.color = netBal < 0 ? "#ef4444" : "#3b82f6";

        if (data.length === 0) {
          listDiv.innerHTML = `<div style="text-align:center; padding:60px; color:#94a3b8; font-size:14px;">${langData[currentLang].empty}</div>`;
        }
      }

      function filterData() {
        const term = document.getElementById("search-bar").value.toLowerCase();
        const filtered = allData.filter(
          (i) =>
            i.category.toLowerCase().includes(term) ||
            (i.notes && i.notes.toLowerCase().includes(term)),
        );
        renderList(filtered);
      }

      async function deleteItem(id) {
        if (confirm(langData[currentLang].confirm)) {
          const { error } = await _supabase
            .from("transactions")
            .delete()
            .eq("id", id);
          if (!error) loadFullHistory();
        }
      }

      function exportCSV() {
        if (allData.length === 0) return;
        let csv =
          "Date,Category,Type,Amount,Notes\n" +
          allData
            .map(
              (r) =>
                `${r.date},${r.category},${r.type},${r.amount},"${r.notes || ""}"`,
            )
            .join("\n");
        const blob = new Blob([csv], { type: "text/csv" });
        const a = document.createElement("a");
        a.href = window.URL.createObjectURL(blob);
        a.download = `History_Export.csv`;
        a.click();
      }

      window.onload = () => {
        const savedTheme = localStorage.getItem("theme") || "light";
        document.documentElement.setAttribute("data-theme", savedTheme);
        document.getElementById("theme-icon").className =
          savedTheme === "dark" ? "fa-solid fa-sun" : "fa-solid fa-moon";
        changeLang(currentLang);
        loadFullHistory();
      };
    </script>
  </body>
</html>
