<!doctype html>
<html lang="my">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Finance Tracker - Full History</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="history.css" />
  </head>
  <body>
    <div class="history-container">
      <div class="top-header">
        <button
          class="btn-dashboard"
          onclick="window.location.href = 'dashboard.html'"
        >
          <i class="fa-solid fa-house"></i>
          <span id="lbl-back">Home</span>
        </button>

        <div class="header-right">
          <button class="theme-toggle" onclick="toggleDarkMode()">
            <i class="fa-solid fa-moon" id="theme-icon"></i>
          </button>
          <div class="lang-switcher">
            <button class="lang-btn" id="btn-en" onclick="changeLang('en')">
              EN
            </button>
            <button class="lang-btn" id="btn-mm" onclick="changeLang('mm')">
              MM
            </button>
          </div>
        </div>
      </div>

      <div class="balance-card">
        <small id="lbl-total-amount">Total Amount</small>
        <div class="amount" id="stat-bal">0</div>
      </div>

      <div class="overview-grid">
        <button class="stat-btn" id="card-inc" onclick="toggleFilter('income')">
          <h4 id="lbl-inc">Income</h4>
          <div class="amount" id="stat-inc">0</div>
        </button>
        <button
          class="stat-btn"
          id="card-exp"
          onclick="toggleFilter('expense')"
        >
          <h4 id="lbl-exp">Expense</h4>
          <div class="amount" id="stat-exp">0</div>
        </button>
      </div>

      <div class="filter-bar">
        <div class="search-box">
          <i class="fa-solid fa-magnifying-glass"></i>
          <input
            type="text"
            id="search-bar"
            onkeyup="handleSearch(this)"
            placeholder="Search..."
          />
          <button
            id="clear-search"
            class="btn-clear-search"
            onclick="clearSearch()"
          >
            <i class="fa-solid fa-circle-xmark"></i>
          </button>
        </div>
        <div class="date-filter-group">
          <input type="date" id="date-from" onchange="loadFullHistory()" />
          <input type="date" id="date-to" onchange="loadFullHistory()" />
          <button class="btn-reset" onclick="resetFilters()">
            <i class="fa-solid fa-rotate-right"></i>
          </button>
        </div>
      </div>

      <div class="history-header-row">
        <span class="history-title" id="lbl-trans-title">Transactions</span>
        <div style="display: flex; gap: 8px">
          <button
            class="btn-download-modern"
            style="background: var(--primary)"
            onclick="window.location.href = 'addnew.html'"
          >
            <i class="fa-solid fa-plus"></i>
            <span id="lbl-add-new">Add New</span>
          </button>

          <button class="btn-download-modern" onclick="exportCSV()">
            <i class="fa-solid fa-file-excel"></i>
            <span id="lbl-export">Export</span>
          </button>
        </div>
      </div>

      <div id="full-history-list"></div>
    </div>

    <script>
      const supabaseUrl = "https://utvivcjbmyhsmkjfqgra.supabase.co";
      const supabaseKey = "sb_publishable_uih5zl6drERvSSf0AN4qmQ_MqX8SY8G";
      const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

      let allData = [];
      let currentLang = localStorage.getItem("selectedLang") || "mm";
      let activeTypeFilter = null;

      const catIcons = {
        Salary: "fa-wallet",
        Bonus: "fa-gift",
        Gifts: "fa-hand-holding-heart",
        Investment: "fa-chart-line",
        Other: "fa-plus",
        Food: "fa-utensils",
        Transport: "fa-car",
        Shopping: "fa-bag-shopping",
        Rent: "fa-house",
        Health: "fa-heart-pulse",
        Bills: "fa-credit-card",
        General: "fa-tags",
      };

      const langData = {
        mm: {
          back: "ပင်မစာမျက်နှာ",
          inc: "ဝင်ငွေ",
          exp: "အသုံးစရိတ်",
          bal: "စုစုပေါင်း ပမာဏ",
          empty: "မှတ်တမ်းမရှိပါ။",
          confirm: "ဖျက်မှာ သေချာပါသလား?",
          trans: "စာရင်းမှတ်တမ်းများ",
          export: "Excel ထုတ်ရန်",
          addNew: "အသစ်ထည့်ရန်",
          editNotePrompt: "မှတ်စုကို ပြင်ဆင်ရန်:",
          searchPlaceholder: "မှတ်စု ဖြင့် ရှာပါ",
          Salary: "လစာ",
          Bonus: "ဆုကြေး",
          Gifts: "လက်ဆောင်",
          Investment: "ရင်းနှီးမြှုပ်နှံမှု",
          Other: "အခြား",
          Food: "စားစရိတ်",
          Transport: "ခရီးစရိတ်",
          Shopping: "ဝယ်ယူမှု",
          Rent: "အိမ်လခ",
          Health: "ကျန်းမာရေး",
          Bills: "မီတာ/ဘေလ်",
          General: "အထွေထွေ",
        },
        en: {
          back: "Home",
          inc: "Income",
          exp: "Expense",
          bal: "Total Amount",
          empty: "No records found.",
          confirm: "Delete this record?",
          trans: "Transactions",
          export: "Export CSV",
          addNew: "Add New",
          editNotePrompt: "Edit Note:",
          searchPlaceholder: "Search by notes...",
          Salary: "Salary",
          Bonus: "Bonus",
          Gifts: "Gifts",
          Investment: "Invest",
          Other: "Other",
          Food: "Food",
          Transport: "Transport",
          Shopping: "Shopping",
          Rent: "Rent",
          Health: "Health",
          Bills: "Bills",
          General: "General",
        },
      };

      function handleSearch(input) {
        document.getElementById("clear-search").style.display = input.value
          ? "block"
          : "none";
        filterData();
      }

      function clearSearch() {
        document.getElementById("search-bar").value = "";
        document.getElementById("clear-search").style.display = "none";
        filterData();
      }

      function toggleDarkMode() {
        const target =
          document.documentElement.getAttribute("data-theme") === "dark"
            ? "light"
            : "dark";
        document.documentElement.setAttribute("data-theme", target);
        localStorage.setItem("theme", target);
        document.getElementById("theme-icon").className =
          target === "dark" ? "fa-solid fa-sun" : "fa-solid fa-moon";
      }

      function changeLang(lang) {
        currentLang = lang;
        localStorage.setItem("selectedLang", lang);

        document.getElementById("lbl-back").innerText = langData[lang].back;
        document.getElementById("lbl-inc").innerText = langData[lang].inc;
        document.getElementById("lbl-exp").innerText = langData[lang].exp;
        document.getElementById("lbl-total-amount").innerText =
          langData[lang].bal;
        document.getElementById("lbl-trans-title").innerText =
          langData[lang].trans;
        document.getElementById("lbl-export").innerText = langData[lang].export;
        document.getElementById("lbl-add-new").innerText =
          langData[lang].addNew;
        document.getElementById("search-bar").placeholder =
          langData[lang].searchPlaceholder;

        document
          .querySelectorAll(".lang-btn")
          .forEach((b) => b.classList.toggle("active", b.id === `btn-${lang}`));
        renderList(allData);
      }

      function toggleFilter(type) {
        activeTypeFilter = activeTypeFilter === type ? null : type;
        loadFullHistory();
      }

      function resetFilters() {
        document.getElementById("date-from").value = "";
        document.getElementById("date-to").value = "";
        document.getElementById("search-bar").value = "";
        activeTypeFilter = null;
        loadFullHistory();
      }

      async function loadFullHistory() {
        const {
          data: { user },
        } = await _supabase.auth.getUser();
        if (!user) return (window.location.href = "index.html");

        // SORT BY ID DESC: Ensures most recently created or updated record stays on top
        let query = _supabase
          .from("transactions")
          .select("*")
          .order("id", { ascending: false });

        const df = document.getElementById("date-from").value;
        const dt = document.getElementById("date-to").value;

        if (df) query = query.gte("date", df);
        if (dt) query = query.lte("date", dt);
        if (activeTypeFilter === "income") query = query.eq("type", "Income");
        if (activeTypeFilter === "expense") query = query.eq("type", "Expense");

        const { data } = await query;
        if (data) {
          allData = data;
          renderList(data);
          updateFilterUI();
        }
      }

      function updateFilterUI() {
        const cardInc = document.getElementById("card-inc");
        const cardExp = document.getElementById("card-exp");

        cardInc.classList.toggle(
          "filter-active",
          activeTypeFilter === "income",
        );
        cardExp.classList.toggle(
          "filter-active",
          activeTypeFilter === "expense",
        );
      }

      async function editNote(id, currentNote) {
        const newNote = prompt(
          langData[currentLang].editNotePrompt,
          currentNote || "",
        );
        if (newNote !== null) {
          const { error } = await _supabase
            .from("transactions")
            .update({ notes: newNote })
            .eq("id", id);
          if (!error) loadFullHistory();
        }
      }

      function renderList(data) {
        const listDiv = document.getElementById("full-history-list");
        listDiv.innerHTML = "";

        let tInc = 0,
          tExp = 0,
          lastMonth = "";

        data.forEach((item) => {
          if (item.type === "Income") tInc += item.amount;
          else tExp += item.amount;

          const monthName = new Date(item.date).toLocaleString(
            currentLang === "mm" ? "my-MM" : "en-US",
            { month: "long", year: "numeric" },
          );
          if (monthName !== lastMonth) {
            listDiv.innerHTML += `<div class="month-group-label">${monthName}</div>`;
            lastMonth = monthName;
          }

          const isInc = item.type === "Income";
          const icon = catIcons[item.category] || "fa-receipt";

          listDiv.innerHTML += `
            <div class="transaction-item">
              <div class="icon-circle ${isInc ? "inc-icon" : "exp-icon"}">
                <i class="fa-solid ${icon}"></i>
              </div>
              <div class="item-middle">
                <span class="item-category">${langData[currentLang][item.category] || item.category}</span>
                <div class="note-bubble" onclick="editNote(${item.id}, '${item.notes || ""}')" title="Click to edit">
                  <i class="fa-solid fa-pen-to-square"></i>
                  ${item.notes || "..."}
                </div>
                <span class="item-date">${item.date}</span>
              </div>
              <div class="item-right">
                <div class="item-amount ${isInc ? "text-inc" : "text-exp"}">
                  ${isInc ? "+" : "-"} ${item.amount.toLocaleString()}
                </div>
                <button class="btn-del" onclick="deleteItem(${item.id})">
                  <i class="fa-solid fa-trash-can"></i>
                </button>
              </div>
            </div>`;
        });

        const netBal = tInc - tExp;
        document.getElementById("stat-inc").innerText = tInc.toLocaleString();
        document.getElementById("stat-exp").innerText = tExp.toLocaleString();

        const balEl = document.getElementById("stat-bal");
        balEl.innerText = netBal.toLocaleString();

        balEl.className =
          "amount " + (netBal < 0 ? "negative-balance" : "positive-balance");

        if (data.length === 0) {
          listDiv.innerHTML = `<div class="empty-state">${langData[currentLang].empty}</div>`;
        }
      }

      function filterData() {
        const term = document.getElementById("search-bar").value.toLowerCase();
        const filtered = allData.filter(
          (i) =>
            i.category.toLowerCase().includes(term) ||
            (i.notes && i.notes.toLowerCase().includes(term)),
        );
        renderList(filtered);
      }

      async function deleteItem(id) {
        if (confirm(langData[currentLang].confirm)) {
          const { error } = await _supabase
            .from("transactions")
            .delete()
            .eq("id", id);
          if (!error) loadFullHistory();
        }
      }

      function exportCSV() {
        if (allData.length === 0) return;
        let csv =
          "Date,Category,Type,Amount,Notes\n" +
          allData
            .map(
              (r) =>
                `${r.date},${r.category},${r.type},${r.amount},"${r.notes || ""}"`,
            )
            .join("\n");
        const blob = new Blob([csv], { type: "text/csv" });
        const a = document.createElement("a");
        a.href = window.URL.createObjectURL(blob);
        a.download = `History_Export.csv`;
        a.click();
      }

      window.onload = () => {
        const savedTheme = localStorage.getItem("theme") || "light";
        document.documentElement.setAttribute("data-theme", savedTheme);
        document.getElementById("theme-icon").className =
          savedTheme === "dark" ? "fa-solid fa-sun" : "fa-solid fa-moon";
        changeLang(currentLang);
        loadFullHistory();
      };
    </script>
  </body>
</html>
