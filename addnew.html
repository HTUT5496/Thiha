<!doctype html>
<html lang="my" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Add Transaction - Finance Tracker</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
      // Authentication Guard
      const tempSupabaseUrl = "https://utvivcjbmyhsmkjfqgra.supabase.co";
      const tempSupabaseKey = "sb_publishable_uih5zl6drERvSSf0AN4qmQ_MqX8SY8G";
      const _tempSupabase = supabase.createClient(
        tempSupabaseUrl,
        tempSupabaseKey,
      );

      _tempSupabase.auth.getSession().then(({ data: { session } }) => {
        if (!session) {
          window.location.href = "index.html";
        }
      });
    </script>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="addnew.css" />
  </head>
  <body>
    <div class="container">
      <div class="top-nav">
        <div class="nav-left">
          <button class="btn-nav" id="btnBack">
            <i class="fa-solid fa-chevron-left"></i>
            <span id="lbl-back">Back</span>
          </button>
          <button
            class="btn-nav"
            onclick="window.location.href = 'dashboard.html'"
          >
            <i class="fa-solid fa-house"></i>
          </button>
        </div>

        <div class="nav-right">
          <button class="theme-toggle" id="theme-icon" onclick="toggleTheme()">
            üåô
          </button>
          <div class="lang-switcher">
            <button
              class="lang-btn"
              id="btn-lang-toggle"
              onclick="toggleLang()"
            >
              ENGLISH
            </button>
          </div>
        </div>
      </div>

      <div class="type-selector">
        <button
          class="type-btn active"
          id="btn-inc"
          data-type="Income"
          onclick="setType('Income')"
        >
          Income
        </button>
        <button
          class="type-btn"
          id="btn-exp"
          data-type="Expense"
          onclick="setType('Expense')"
        >
          Expense
        </button>
      </div>

      <div class="category-grid" id="categoryGrid"></div>
    </div>

    <div class="modal-overlay" id="modalOverlay">
      <div class="modal-content">
        <div class="modal-header-custom">
          <h3 id="lbl-modal-title">New Transaction</h3>
          <span id="modalTitle">Category</span>
        </div>

        <form id="txForm">
          <div class="form-group">
            <input type="date" id="date" required />
          </div>
          <div class="form-group">
            <input
              type="number"
              id="amount"
              placeholder="Amount"
              inputmode="decimal"
              required
            />
          </div>
          <div class="form-group">
            <textarea id="notes" rows="3" placeholder="Notes"></textarea>
          </div>

          <button type="submit" class="btn-save" id="btnSave">
            <div class="spinner" id="loader"></div>
            <span id="btnText">Save Record</span>
          </button>

          <button
            type="button"
            class="btn-cancel-link"
            onclick="closeModal()"
            id="lbl-cancel"
          >
            Cancel
          </button>
        </form>
      </div>
    </div>

    <script>
      const supabaseUrl = "https://utvivcjbmyhsmkjfqgra.supabase.co";
      const supabaseKey = "sb_publishable_uih5zl6drERvSSf0AN4qmQ_MqX8SY8G";
      const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

      let selectedType = "Income";
      let activeCategory = "";
      let currentLang = localStorage.getItem("selectedLang") || "mm";

      const langData = {
        mm: {
          back: "·Äî·Ä±·Ä¨·ÄÄ·Ä∫·Äû·Ä≠·ÄØ·Ä∑",
          inc: "·Äù·ÄÑ·Ä∫·ÄÑ·ÄΩ·Ä±",
          exp: "·Ä°·Äû·ÄØ·Ä∂·Ä∏·ÄÖ·Äõ·Ä≠·Äê·Ä∫",
          newTx: "·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏·Ä°·Äû·ÄÖ·Ä∫",
          amt: "·Äï·Äô·Ä¨·Äè",
          note: "·Äô·Äæ·Äê·Ä∫·ÄÖ·ÄØ",
          cancel: "·Äô·Äú·ÄØ·Äï·Ä∫·Äê·Ä±·Ä¨·Ä∑·Äï·Ä´",
          save: "·Äû·Ä≠·Äô·Ä∫·Ä∏·ÄÜ·Ää·Ä∫·Ä∏·Äô·Ää·Ä∫",
          saving: "·Äû·Ä≠·Äô·Ä∫·Ä∏·Äî·Ä±·Äû·Ää·Ä∫...",
          Salary: "·Äú·ÄÖ·Ä¨",
          Bonus: "·ÄÜ·ÄØ·ÄÄ·Äº·Ä±·Ä∏",
          Gifts: "·Äú·ÄÄ·Ä∫·ÄÜ·Ä±·Ä¨·ÄÑ·Ä∫",
          Invest: "·Äõ·ÄÑ·Ä∫·Ä∏·Äî·Äæ·ÄÆ·Ä∏·Äô·Äº·Äæ·ÄØ·Äï·Ä∫·Äî·Äæ·Ä∂·Äô·Äæ·ÄØ",
          Other: "·Ä°·ÄÅ·Äº·Ä¨·Ä∏",
          Food: "·ÄÖ·Ä¨·Ä∏·ÄÖ·Äõ·Ä≠·Äê·Ä∫",
          Transport: "·ÄÅ·Äõ·ÄÆ·Ä∏·ÄÖ·Äõ·Ä≠·Äê·Ä∫",
          Shopping: "·Äù·Äö·Ä∫·Äö·Ä∞·Äô·Äæ·ÄØ",
          Rent: "·Ä°·Ä≠·Äô·Ä∫·Äú·ÄÅ",
          Health: "·ÄÄ·Äª·Äî·Ä∫·Ä∏·Äô·Ä¨·Äõ·Ä±·Ä∏",
          Bills: "·Äô·ÄÆ·Äê·Ä¨/·Äò·Ä±·Äú·Ä∫",
          General: "·Ä°·Äë·ÄΩ·Ä±·Äë·ÄΩ·Ä±",
        },
        en: {
          back: "Back",
          inc: "Income",
          exp: "Expense",
          newTx: "New Transaction",
          amt: "Amount",
          note: "Notes",
          cancel: "Cancel",
          save: "Save Record",
          saving: "Saving...",
          Salary: "Salary",
          Bonus: "Bonus",
          Gifts: "Gifts",
          Invest: "Invest",
          Other: "Other",
          Food: "Food",
          Transport: "Transport",
          Shopping: "Shopping",
          Rent: "Rent",
          Health: "Health",
          Bills: "Bills",
          General: "General",
        },
      };

      const categories = {
        Income: [
          { id: "Salary", icon: "fa-wallet", color: "#10b981" },
          { id: "Bonus", icon: "fa-gift", color: "#10b981" },
          { id: "Gifts", icon: "fa-hand-holding-heart", color: "#10b981" },
          { id: "Invest", icon: "fa-chart-line", color: "#10b981" },
          { id: "Other", icon: "fa-plus", color: "#10b981" },
        ],
        Expense: [
          { id: "Food", icon: "fa-utensils", color: "#ef4444" },
          { id: "Transport", icon: "fa-car", color: "#ef4444" },
          { id: "Shopping", icon: "fa-bag-shopping", color: "#ef4444" },
          { id: "Rent", icon: "fa-house", color: "#ef4444" },
          { id: "Health", icon: "fa-heart-pulse", color: "#ef4444" },
          { id: "Bills", icon: "fa-credit-card", color: "#ef4444" },
          { id: "General", icon: "fa-tags", color: "#ef4444" },
        ],
      };

      document.getElementById("btnBack").onclick = () => window.history.back();

      function toggleLang() {
        currentLang = currentLang === "mm" ? "en" : "mm";
        localStorage.setItem("selectedLang", currentLang);
        applyLanguage();
      }

      function applyLanguage() {
        const d = langData[currentLang];
        document.getElementById("lbl-back").innerText = d.back;
        document.getElementById("btn-inc").innerText = d.inc;
        document.getElementById("btn-exp").innerText = d.exp;
        document.getElementById("lbl-modal-title").innerText = d.newTx;
        document.getElementById("amount").placeholder = d.amt;
        document.getElementById("notes").placeholder = d.note;
        document.getElementById("lbl-cancel").innerText = d.cancel;
        document.getElementById("btnText").innerText = d.save;
        document.getElementById("btn-lang-toggle").innerText =
          currentLang === "mm" ? "ENGLISH" : "·Äô·Äº·Äî·Ä∫·Äô·Ä¨";
        renderGrid();
      }

      function toggleTheme() {
        const html = document.documentElement;
        const newTheme =
          html.getAttribute("data-theme") === "light" ? "dark" : "light";
        html.setAttribute("data-theme", newTheme);
        document.getElementById("theme-icon").innerText =
          newTheme === "dark" ? "‚òÄÔ∏è" : "üåô";
        localStorage.setItem("theme", newTheme);
      }

      function setType(type) {
        selectedType = type;
        document
          .querySelectorAll(".type-btn")
          .forEach((btn) =>
            btn.classList.toggle("active", btn.dataset.type === type),
          );
        renderGrid();
      }

      function renderGrid() {
        const grid = document.getElementById("categoryGrid");
        grid.innerHTML = categories[selectedType]
          .map(
            (cat) => `
          <div class="cat-card" onclick="openModal('${cat.id}', '${cat.icon}', '${cat.color}')">
            <i class="fa-solid ${cat.icon}" style="color: ${cat.color}"></i>
            <span>${langData[currentLang][cat.id]}</span>
          </div>
        `,
          )
          .join("");
      }

      function openModal(id, icon, color) {
        activeCategory = id;
        document.getElementById("modalTitle").innerText =
          langData[currentLang][id];

        const saveBtn = document.getElementById("btnSave");
        saveBtn.style.background =
          selectedType === "Income" ? "#10b981" : "#ef4444";

        // Hand-over effect for shadows
        saveBtn.style.boxShadow =
          selectedType === "Income"
            ? "0 10px 20px rgba(16, 185, 129, 0.3)"
            : "0 10px 20px rgba(239, 68, 68, 0.3)";

        document.getElementById("modalOverlay").classList.add("active");
        setTimeout(() => document.getElementById("amount").focus(), 300);
      }

      function closeModal() {
        document.getElementById("modalOverlay").classList.remove("active");
        document.getElementById("txForm").reset();
        document.getElementById("date").valueAsDate = new Date();
      }

      document.getElementById("txForm").onsubmit = async (e) => {
        e.preventDefault();
        const btnSave = document.getElementById("btnSave");
        const loader = document.getElementById("loader");
        const btnText = document.getElementById("btnText");

        btnSave.disabled = true;
        loader.style.display = "block";
        btnText.innerText = langData[currentLang].saving;

        const {
          data: { user },
        } = await _supabase.auth.getUser();

        const { error } = await _supabase.from("transactions").insert([
          {
            user_id: user.id,
            amount: parseFloat(document.getElementById("amount").value),
            category: activeCategory,
            date: document.getElementById("date").value,
            notes: document.getElementById("notes").value,
            type: selectedType,
          },
        ]);

        if (!error) {
          window.location.href = "history.html";
        } else {
          alert(error.message);
          btnSave.disabled = false;
          loader.style.display = "none";
          btnText.innerText = langData[currentLang].save;
        }
      };

      window.onload = () => {
        const savedTheme = localStorage.getItem("theme") || "light";
        document.documentElement.setAttribute("data-theme", savedTheme);
        document.getElementById("theme-icon").innerText =
          savedTheme === "dark" ? "‚òÄÔ∏è" : "üåô";
        document.getElementById("date").valueAsDate = new Date();
        applyLanguage();
        setType("Income");
      };
    </script>
  </body>
</html>
