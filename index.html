<!doctype html>
<html lang="my" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Finance Tracker - Register</title>
    <link rel="apple-touch-icon" href="icon-192.png" />
    <link rel="manifest" href="manifest.json" />
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="auth-wrapper">
      <div class="top-controls">
        <div class="lang-switcher">
          <button
            class="lang-btn active"
            id="btn-lang-toggle"
            onclick="toggleLang()"
          >
            EN
          </button>
        </div>
        <div class="nav-actions">
          <button
            class="theme-toggle nav-login-btn"
            onclick="showForm('login')"
            id="lbl-nav-login"
          >
            á€á€„á€ºá€›á€”á€º
          </button>
          <button class="theme-toggle" onclick="toggleTheme()" id="theme-icon">
            ğŸŒ™
          </button>
        </div>
      </div>

      <div class="welcome-info">
        <p id="lbl-app-info">
          á€¤ Application á€€á€­á€¯ á€á€¯á€¶á€¸á€á€¼á€„á€ºá€¸á€¡á€¬á€¸á€–á€¼á€„á€·á€º á€á€„á€·á€ºá á€á€„á€ºá€„á€½á€± á€”á€¾á€„á€·á€º á€‘á€½á€€á€ºá€„á€½á€± á€€á€­á€¯
          á€€á€±á€¬á€„á€ºá€¸á€…á€½á€¬ á€…á€®á€™á€¶á€á€”á€·á€ºá€á€½á€² á€”á€­á€¯á€„á€ºá€•á€«á€á€Šá€ºá‹
        </p>
      </div>

      <div class="auth-card">
        <div id="signup-form">
          <div class="header">
            <h2 id="lbl-signup-title">á€¡á€€á€±á€¬á€„á€·á€ºá€á€…á€ºá€–á€½á€„á€·á€ºá€›á€”á€º</h2>
            <p class="subtitle">Join us to start tracking</p>
          </div>
          <div class="input-group">
            <input type="email" id="signup-email" placeholder="Gmail á€œá€­á€•á€ºá€…á€¬" />
            <div class="password-container">
              <input
                type="password"
                id="signup-password"
                placeholder="á€…á€€á€¬á€¸á€á€¾á€€á€ºá€¡á€á€…á€º"
              />
              <span
                class="toggle-eye"
                onclick="togglePass('signup-password', this)"
                >ğŸ‘ï¸</span
              >
            </div>
            <div class="password-container">
              <input
                type="password"
                id="signup-confirm"
                placeholder="á€…á€€á€¬á€¸á€á€¾á€€á€ºá€¡á€á€Šá€ºá€•á€¼á€¯á€•á€«"
              />
              <span
                class="toggle-eye"
                onclick="togglePass('signup-confirm', this)"
                >ğŸ‘ï¸</span
              >
            </div>
          </div>
          <button
            class="primary-btn"
            id="lbl-signup-btn"
            onclick="handleSignUp()"
          >
            á€¡á€á€Šá€ºá€•á€¼á€¯á€œá€½á€¾á€¬ á€•á€­á€¯á€·á€›á€”á€º
          </button>
          <div class="link-container">
            <span class="link" id="lbl-go-login" onclick="showForm('login')"
              >á€¡á€€á€±á€¬á€„á€·á€ºá€›á€¾á€­á€•á€¼á€®á€¸á€á€¬á€¸á€œá€¬á€¸? á€•á€¼á€”á€ºá€á€„á€ºá€›á€”á€º</span
            >
          </div>
        </div>

        <div id="login-form" class="hidden">
          <div class="header">
            <h2 id="lbl-login-title">á€á€„á€ºá€›á€”á€º</h2>
            <p class="subtitle">Enter your details to continue</p>
          </div>
          <div class="input-group">
            <input
              type="email"
              id="login-email"
              placeholder="Gmail á€œá€­á€•á€ºá€…á€¬"
              required
            />
            <div class="password-container">
              <input
                type="password"
                id="login-password"
                placeholder="á€…á€€á€¬á€¸á€á€¾á€€á€º"
                required
              />
              <span
                class="toggle-eye"
                onclick="togglePass('login-password', this)"
                >ğŸ‘ï¸</span
              >
            </div>
          </div>
          <button
            class="primary-btn"
            id="lbl-login-btn"
            onclick="handleLogin()"
          >
            á€á€„á€ºá€™á€Šá€º
          </button>
          <div class="link-container">
            <span class="link" id="lbl-go-signup" onclick="showForm('signup')"
              >á€¡á€€á€±á€¬á€„á€·á€ºá€¡á€á€…á€ºá€–á€½á€„á€·á€ºá€›á€”á€º</span
            ><br />
            <span class="link" id="lbl-go-forgot" onclick="showForm('forgot')"
              >á€…á€€á€¬á€¸á€á€¾á€€á€ºá€™á€±á€·á€”á€±á€á€œá€¬á€¸?</span
            >
          </div>
        </div>

        <div id="forgot-form" class="hidden">
          <div class="header">
            <h2 id="lbl-forgot-title">á€…á€€á€¬á€¸á€á€¾á€€á€º á€•á€¼á€”á€ºá€šá€°á€›á€”á€º</h2>
            <p class="subtitle">We'll send a link to your email</p>
          </div>
          <div class="input-group">
            <input
              type="email"
              id="forgot-email"
              placeholder="á€á€„á€ºá Gmail á€›á€­á€¯á€€á€ºá€‘á€Šá€·á€ºá€•á€«"
            />
          </div>
          <button
            class="primary-btn"
            id="lbl-forgot-btn"
            onclick="handleForgotPassword()"
          >
            Link á€•á€­á€¯á€·á€›á€”á€º
          </button>
          <div class="link-container">
            <span class="link" onclick="showForm('login')">á€•á€¼á€”á€ºá€á€½á€¬á€¸á€›á€”á€º</span>
          </div>
        </div>

        <div id="reset-password-form" class="hidden">
          <div class="header">
            <h2 id="lbl-reset-title">á€…á€€á€¬á€¸á€á€¾á€€á€ºá€¡á€á€…á€ºá€á€á€ºá€™á€¾á€á€ºá€›á€”á€º</h2>
            <p class="subtitle">Type your new password below</p>
          </div>
          <div class="input-group">
            <div class="password-container">
              <input
                type="password"
                id="new-password"
                placeholder="á€…á€€á€¬á€¸á€á€¾á€€á€ºá€¡á€á€…á€º"
              />
              <span
                class="toggle-eye"
                onclick="togglePass('new-password', this)"
                >ğŸ‘ï¸</span
              >
            </div>
          </div>
          <button
            class="primary-btn"
            id="lbl-reset-save-btn"
            onclick="handleUpdatePassword()"
          >
            á€…á€€á€¬á€¸á€á€¾á€€á€ºá€¡á€á€…á€ºá€á€­á€™á€ºá€¸á€™á€Šá€º
          </button>
        </div>

        <div id="status" class="status-msg hidden"></div>
      </div>
    </div>

    <script>
      const supabaseUrl = "https://utvivcjbmyhsmkjfqgra.supabase.co";
      const supabaseKey = "sb_publishable_uih5zl6drERvSSf0AN4qmQ_MqX8SY8G";
      const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

      // --- Updated Auth Check to prevent skipping Reset Password ---
      async function checkAuth() {
        // Detect if the URL contains the recovery token
        const isRecovery =
          window.location.hash &&
          window.location.hash.includes("type=recovery");

        const {
          data: { session },
        } = await _supabase.auth.getSession();

        // Only redirect to dashboard if we have a session AND it's NOT a password recovery flow
        if (session && !isRecovery) {
          window.location.href = "dashboard.html";
        }
      }

      // Check auth state immediately
      checkAuth();

      _supabase.auth.onAuthStateChanged((event, session) => {
        if (event === "PASSWORD_RECOVERY") {
          showForm("reset-password");
        }
      });

      // ... (togglePass, toggleTheme, toggleLang, changeLang, showForm, setStatus, resetButton functions remain the same) ...
      function togglePass(id, el) {
        const input = document.getElementById(id);
        if (input.type === "password") {
          input.type = "text";
          el.innerText = "ğŸ™ˆ";
        } else {
          input.type = "password";
          el.innerText = "ğŸ‘ï¸";
        }
      }

      const translations = {
        mm: {
          labels: {
            "app-info":
              "á€¤ Application á€€á€­á€¯ á€á€¯á€¶á€¸á€á€¼á€„á€ºá€¸á€¡á€¬á€¸á€–á€¼á€„á€·á€º á€á€„á€·á€ºá á€á€„á€ºá€„á€½á€± á€”á€¾á€„á€·á€º á€‘á€½á€€á€ºá€„á€½á€± á€€á€­á€¯ á€€á€±á€¬á€„á€ºá€¸á€…á€½á€¬ á€…á€®á€™á€¶á€á€”á€·á€ºá€á€½á€² á€”á€­á€¯á€„á€ºá€•á€«á€á€Šá€ºá‹",
            "login-title": "á€á€„á€ºá€›á€”á€º",
            "signup-title": "á€¡á€€á€±á€¬á€„á€·á€ºá€á€…á€ºá€–á€½á€„á€·á€ºá€›á€”á€º",
            "forgot-title": "á€…á€€á€¬á€¸á€á€¾á€€á€º á€•á€¼á€”á€ºá€šá€°á€›á€”á€º",
            "reset-title": "á€…á€€á€¬á€¸á€á€¾á€€á€ºá€¡á€á€…á€ºá€á€á€ºá€™á€¾á€á€ºá€›á€”á€º",
            "login-btn": "á€á€„á€ºá€™á€Šá€º",
            "signup-btn": "á€¡á€á€Šá€ºá€•á€¼á€¯á€œá€½á€¾á€¬ á€•á€­á€¯á€·á€›á€”á€º",
            "forgot-btn": "Link á€•á€­á€¯á€·á€›á€”á€º",
            "reset-save-btn": "á€…á€€á€¬á€¸á€á€¾á€€á€ºá€¡á€á€…á€ºá€á€­á€™á€ºá€¸á€™á€Šá€º",
            "go-signup": "á€¡á€€á€±á€¬á€„á€·á€ºá€¡á€á€…á€ºá€–á€½á€„á€·á€ºá€›á€”á€º",
            "go-forgot": "á€…á€€á€¬á€¸á€á€¾á€€á€ºá€™á€±á€·á€”á€±á€á€œá€¬á€¸?",
            "go-login": "á€¡á€€á€±á€¬á€„á€·á€ºá€›á€¾á€­á€•á€¼á€®á€¸á€á€¬á€¸á€œá€¬á€¸? á€•á€¼á€”á€ºá€á€„á€ºá€›á€”á€º",
            "nav-login": "á€á€„á€ºá€›á€”á€º",
          },
          placeholders: {
            "login-email": "Gmail á€œá€­á€•á€ºá€…á€¬",
            "login-password": "á€…á€€á€¬á€¸á€á€¾á€€á€º",
            "signup-email": "Gmail á€œá€­á€•á€ºá€…á€¬",
            "signup-password": "á€…á€€á€¬á€¸á€á€¾á€€á€ºá€¡á€á€…á€º",
            "signup-confirm": "á€…á€€á€¬á€¸á€á€¾á€€á€ºá€¡á€á€Šá€ºá€•á€¼á€¯á€•á€«",
            "forgot-email": "á€á€„á€ºá Gmail á€›á€­á€¯á€€á€ºá€‘á€Šá€·á€ºá€•á€«",
            "new-password": "á€…á€€á€¬á€¸á€á€¾á€€á€ºá€¡á€á€…á€º",
          },
        },
        en: {
          labels: {
            "app-info":
              "By using this application, you can effectively manage your income and expenses.",
            "login-title": "Welcome Back",
            "signup-title": "Create Account",
            "forgot-title": "Reset Password",
            "reset-title": "New Password",
            "login-btn": "Sign In",
            "signup-btn": "Register Now",
            "forgot-btn": "Send Reset Link",
            "reset-save-btn": "Save New Password",
            "go-signup": "Don't have an account? Sign up",
            "go-forgot": "Forgot password?",
            "go-login": "Already have an account? Login",
            "nav-login": "Login",
          },
          placeholders: {
            "login-email": "Email Address",
            "login-password": "Password",
            "signup-email": "Email Address",
            "signup-password": "New Password",
            "signup-confirm": "Confirm Password",
            "forgot-email": "Enter your Email",
            "new-password": "New Password",
          },
        },
      };

      function toggleTheme() {
        const html = document.documentElement;
        const icon = document.getElementById("theme-icon");
        const newTheme =
          html.getAttribute("data-theme") === "light" ? "dark" : "light";
        html.setAttribute("data-theme", newTheme);
        icon.innerText = newTheme === "dark" ? "â˜€ï¸" : "ğŸŒ™";
        localStorage.setItem("theme", newTheme);
      }

      function toggleLang() {
        const currentLang = localStorage.getItem("selectedLang") || "mm";
        const newLang = currentLang === "mm" ? "en" : "mm";
        changeLang(newLang);
      }

      function changeLang(lang) {
        localStorage.setItem("selectedLang", lang);
        const data = translations[lang];
        Object.keys(data.labels).forEach((id) => {
          const el = document.getElementById(`lbl-${id}`);
          if (el) el.innerText = data.labels[id];
        });
        Object.keys(data.placeholders).forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.placeholder = data.placeholders[id];
        });
        const langToggleBtn = document.getElementById("btn-lang-toggle");
        langToggleBtn.innerText = lang === "mm" ? "á€™á€¼á€”á€ºá€™á€¬" : "EN";
      }

      function showForm(formId) {
        document.getElementById("status").classList.add("hidden");
        [
          "login-form",
          "signup-form",
          "forgot-form",
          "reset-password-form",
        ].forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.classList.add("hidden");
        });
        const target = document.getElementById(formId + "-form");
        if (target) target.classList.remove("hidden");
      }

      function setStatus(msg, isError = true) {
        const el = document.getElementById("status");
        el.innerText = msg;
        el.classList.remove("hidden", "error", "success");
        el.classList.add(isError ? "error" : "success");
      }

      function resetButton(btn, originalText) {
        btn.innerText = originalText;
        btn.disabled = false;
      }

      async function handleLogin() {
        const email = document.getElementById("login-email").value;
        const password = document.getElementById("login-password").value;
        if (!email || !password) return setStatus("Please fill all fields");
        const btn = document.getElementById("lbl-login-btn");
        const originalText = btn.innerText;
        btn.innerHTML = `Loading... <div class="spinner"></div>`;
        btn.disabled = true;
        const { error } = await _supabase.auth.signInWithPassword({
          email,
          password,
        });
        if (error) {
          setStatus(error.message);
          resetButton(btn, originalText);
        } else {
          window.location.href = "dashboard.html";
        }
      }

      async function handleSignUp() {
        const email = document.getElementById("signup-email").value;
        const password = document.getElementById("signup-password").value;
        const confirm = document.getElementById("signup-confirm").value;
        const btn = document.getElementById("lbl-signup-btn");
        const originalText = btn.innerText;
        if (!email || !password || !confirm)
          return setStatus("Please fill all fields");
        if (password !== confirm) return setStatus("Passwords do not match!");
        btn.innerHTML = `Sending... <div class="spinner"></div>`;
        btn.disabled = true;
        const { error } = await _supabase.auth.signUp({ email, password });
        if (error) {
          setStatus(error.message);
        } else {
          setStatus("Check your Gmail to confirm your account!", false);
          setTimeout(() => showForm("login"), 4000);
        }
        resetButton(btn, originalText);
      }

      async function handleForgotPassword() {
        const email = document.getElementById("forgot-email").value;
        if (!email) return setStatus("Email is required");
        const btn = document.getElementById("lbl-forgot-btn");
        const originalText = btn.innerText;
        btn.innerHTML = `Sending... <div class="spinner"></div>`;
        btn.disabled = true;
        const { error } = await _supabase.auth.resetPasswordForEmail(email, {
          redirectTo: window.location.origin + window.location.pathname,
        });
        if (error) {
          setStatus(error.message);
        } else {
          setStatus("Reset link sent! Please check your Gmail.", false);
        }
        resetButton(btn, originalText);
      }

      async function handleUpdatePassword() {
        const newPassword = document.getElementById("new-password").value;
        if (!newPassword) return setStatus("Please enter a new password");
        const btn = document.getElementById("lbl-reset-save-btn");
        const originalText = btn.innerText;
        btn.innerHTML = `Saving... <div class="spinner"></div>`;
        btn.disabled = true;
        const { error } = await _supabase.auth.updateUser({
          password: newPassword,
        });
        if (error) {
          setStatus(error.message);
          resetButton(btn, originalText);
        } else {
          setStatus("Password updated! Redirecting...", false);
          setTimeout(() => {
            window.location.href = "dashboard.html";
          }, 2000);
        }
      }

      // --- Updated window.onload to handle recovery hash immediately ---
      window.onload = () => {
        const savedTheme = localStorage.getItem("theme") || "light";
        document.documentElement.setAttribute("data-theme", savedTheme);
        document.getElementById("theme-icon").innerText =
          savedTheme === "dark" ? "â˜€ï¸" : "ğŸŒ™";

        const savedLang = localStorage.getItem("selectedLang") || "mm";
        changeLang(savedLang);

        const isRecovery =
          window.location.hash &&
          window.location.hash.includes("type=recovery");

        if (isRecovery) {
          // Force the reset form if recovery hash is present
          showForm("reset-password");
        } else {
          // Standard login check
          _supabase.auth.getSession().then(({ data: { session } }) => {
            if (session) {
              window.location.href = "dashboard.html";
            } else {
              showForm("signup");
            }
          });
        }
      };
    </script>
  </body>
</html>
